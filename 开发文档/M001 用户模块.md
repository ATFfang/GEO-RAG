### M001 用户模块

对于用户，我们需要维护两种模式：

1. **人类用户 (User):** 通过账号密码登录。
2. **机器用户 (Agent):** Python 服务，或者未来的 API 开发者，通过 API Key 调用。

#### M001DS 抽象数据结构设计

| **分类**              | **字段名**   | **类型**     | **必/选**                                           | **功能**         |
| ----------------------------- | -------------------- | -------------------- | ----------------------------------------------------------- | ------------------------ |
| **账号认证**          | **Username** | String             | **必填**                                            | 登录唯一凭证，不可修改 |
| **Password**          | String             | **必填**     | BCrypt 加密存储                                           |
| **Email**             | String             | **必填**     | 用于激活账号、找回密码、接收账单                          |
| **Phone**             | String             | *选填*           | 用于短信验证码登录或重要告警（需唯一索引）                |
| **个人画像**          | **Nickname** | String             | **必填**                                            | 昵称，显示在页面右上角，允许重复，支持 Emoji |
| **Avatar**            | String             | *选填*           | 头像 URL，存储在 MinIO 中，未填则显示默认图               |
| **Gender**            | Enum               | *选填*           | 性别，0-保密, 1-男, 2-女                                  |
| **Region**            | String             | *选填*           | 地区                                                      |
| **系统属性**          | **Id**       | String             | ***必填***                                        | 用户uuid |
| **API​ Key**         | String             | *自动*           | 机器调用的凭证                                            |
| **Quota**             | Int                | *自动*           | 剩余积分                                                  |
| **Settings**          | **JSON**     | *选填*           | 扩展字段，存前端偏好（如：深色模式、默认地图底图风格）    |
| **Status**            | int                | ***必填*** | 账号状态：0 - 禁用 / 冻结，1 - 正常，2 - 未激活，3 - 注销 |
| **create\_time**      | DateTime           | *自动*           | 创建时间（账号注册时间）                                  |
| **update\_time**      | DateTime           | *自动*           | 更新时间（字段修改时自动更新）                            |
| **last\_login\_time** | DateTime           | *自动*           | 最后登录时间                                              |
| **last\_login\_ip**   | String             | *自动*           | 最后登录 IP 地址                                          |

#### M001DT 数据表设计

```SQL
-- 创建性别枚举类型
CREATE TYPE user_gender_enum AS ENUM ('0', '1', '2');

-- 系统用户表（sys_user）
CREATE TABLE sys_user (
    -- 系统属性 - 核心主键
    id UUID NOT NULL PRIMARY KEY COMMENT '用户唯一标识（UUID）',
    -- 账号认证
    username VARCHAR(50) NOT NULL COMMENT '登录唯一凭证，不可修改',
    password VARCHAR(100) NOT NULL COMMENT 'BCrypt 加密存储',
    email VARCHAR(100) NOT NULL COMMENT '用于激活账号、找回密码、接收账单',
    phone VARCHAR(20) COMMENT '用于短信验证码登录或重要告警',
    -- 个人画像
    nickname VARCHAR(64) NOT NULL COMMENT '昵称，显示在页面右上角，允许重复，支持 Emoji',
    avatar VARCHAR(255) COMMENT '头像 URL，存储在 MinIO 中，未填则显示默认图',
    gender user_gender_enum DEFAULT '0' COMMENT '性别，0-保密, 1-男, 2-女',
    region VARCHAR(100) COMMENT '地区',
    -- 系统属性
    api_key VARCHAR(64) COMMENT '机器调用的凭证',
    quota INT NOT NULL DEFAULT 0 COMMENT '剩余积分',
    settings JSONB COMMENT '扩展字段，存前端偏好（如：深色模式、默认地图底图风格）',
    status SMALLINT NOT NULL DEFAULT 2 COMMENT '账号状态：0 - 禁用 / 冻结，1 - 正常，2 - 未激活，3 - 注销',
    create_time TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间（账号注册时间）',
    update_time TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间（字段修改时自动更新）',
    last_login_time TIMESTAMP WITH TIME ZONE COMMENT '最后登录时间',
    last_login_ip VARCHAR(50) COMMENT '最后登录 IP 地址',
    
    -- 约束：核心唯一性保障
    CONSTRAINT uk_sys_user_username UNIQUE (username),
    CONSTRAINT uk_sys_user_email UNIQUE (email),
    CONSTRAINT uk_sys_user_phone UNIQUE (phone),
    CONSTRAINT uk_sys_user_api_key UNIQUE (api_key),
    -- 约束：状态值范围校验
    CONSTRAINT ck_sys_user_status CHECK (status IN (0, 1, 2, 3)),
    -- 约束：手机号格式校验（可选，增强数据合法性）
    CONSTRAINT ck_sys_user_phone_format CHECK (phone IS NULL OR phone ~ '^1[3-9]\\d{9}$')
);

-- 索引优化
-- 1. 账号状态索引（高频查询：筛选正常/禁用用户）
CREATE INDEX idx_sys_user_status ON sys_user (status);
-- 2. 创建时间索引（统计新增用户、按注册时间筛选）
CREATE INDEX idx_sys_user_create_time ON sys_user (create_time);
-- 3. 最后登录时间索引（统计活跃用户）
CREATE INDEX idx_sys_user_last_login_time ON sys_user (last_login_time);
-- 4. 手机号索引（模糊查询手机号时用）
CREATE INDEX idx_sys_user_phone ON sys_user (phone);
```

#### M001API 接口文档设计

##### M001API 接口基础信息

* ​**版本**​：v1.0；
* ​**接口前缀**​：**`/api/v1/users`**；
* ​**请求方式**​：RESTful（GET/POST/PUT/DELETE）；
* ​**响应体**​：`{code: 200, msg: "成功", data: {}, timestamp: 1735689600000}`；
* ​**状态码**​：200 - 成功，400 - 参数错误，401 - 未登录，403 - 无权限，500 - 系统错误；
* ​**鉴权方式**​：Bearer Token；
* **模块专属异常码**
  **4001：** 用户名已存在

**4002：** 邮箱格式错误

**4003： ​**邮箱已注册

**4004：** 发送验证码过于频繁

**4005：** 验证码错误或已过期

##### M001API 接口列表

1. ###### 发送邮箱验证码（注册专用）

* ​**接口路径**​：**`/send-register-code`**
* ​**请求方式**​：**POST**
* ​**接口描述**​：向指定邮箱发送注册验证码，验证码有效期 5 分钟，60 秒内仅可发送 1 次
* ​**是否鉴权**​：否
* ​**请求参数**​：

| 参数名          | 类型   | 必选 | 示例       | 说明                       |
| ----------------- | -------- | ------ | ------------ | ---------------------------- |
| **email** | String | 是   | zs@xxx.com | 注册邮箱，需先校验未被注册 |

* ​**响应示例**​：

```JSON
{
  "code": 200,
  "msg": "验证码已发送至邮箱zs@xxx.com，有效期5分钟",
  "data": null,
  "timestamp": 1735689600000
}
```

* ​**异常示例**​：

```JSON
// 邮箱已注册
{
  "code": 4003,
  "msg": "该邮箱已被注册，请更换邮箱",
  "data": null,
  "timestamp": 1735689600000
}

// 发送频率超限
{
  "code": 4004,
  "msg": "验证码发送过于频繁，请60秒后重试",
  "data": null,
  "timestamp": 1735689600000
}
```

2. ###### 用户注册（需验证码验证）

* ​**接口路径**​：**`/register`**
* ​**请求方式**​：**POST**
* ​**接口描述**​：验证邮箱验证码后完成注册，注册后账号状态直接为 “正常”
* ​**是否鉴权**​：否
* ​**请求参数**​：

| 参数名               | 类型   | 必选 | 示例                         | 说明                                               |
| ---------------------- | -------- | ------ | ------------------------------ | ---------------------------------------------------- |
| **username**   | String | 是   | zhangsan123                  | 登录用户名，3-20 位字母 / 数字，唯一且不可修改     |
| **password**   | String | 是   | Zhang@12345                  | 密码，8-20 位，必须包含字母 + 数字（可含特殊字符） |
| **email**      | String | 是   | [zs@xxx.com](mailto:zs@xxx.com) | 注册邮箱（需与发送验证码的邮箱一致）               |
| **verifyCode** | String | 是   | 865921                       | 邮箱收到的 6 位数字验证码                          |
| **phone**      | String | 否   | 13800138000                  | 手机号，11 位，需唯一                              |
| **nickname**   | String | 是   | 张三                         | 昵称，1-64 位，支持 Emoji，允许重复                |

* **响应参数：**

| 参数名          | 类型   | 示例                                | 说明                         |
| ----------------- | -------- | ------------------------------------- | ------------------------------ |
| **id**    | String | 81d4fae-7dec-11d0-a765-00a0c91e6bf6 | 用户 UUID 主键               |
| **token** | String | eyJhbGciOiJIUzI1NiJ9...             | 注册成功后直接返回登录 Token |

* ​**响应示例**​：

```JSON
{
  "code": 200,
  "msg": "注册成功",
  "data": {
    "id": "f81d4fae-7dec-11d0-a765-00a0c91e6bf6",
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJmODFkNGZhZS03ZGVjLTExZDAtYTc2NS0wMGEwYzkxZTZiZjYiLCJleHAiOjE3MzYyOTQ0MDB9.8f7s8d7f8s7d8f7s8d7f8s7d8f7s8d7f8s7d8f7s8d"
  },
  "timestamp": 1735689600000
}
```

* ​**异常示例**​：

```JSON
// 验证码错误/过期
{
  "code": 4005,
  "msg": "验证码错误或已过期，请重新获取",
  "data": null,
  "timestamp": 1735689600000
}

// 用户名已存在
{
  "code": 4001,
  "msg": "用户名已存在",
  "data": null,
  "timestamp": 1735689600000
}
```

3. ###### 用户登陆

* ​**接口路径**​：**`/login`**
* ​**请求方式**​：**POST**
* ​**接口描述**​：支持用户名 / 邮箱 / 手机号 + 密码登录，返回 JWT Token
* ​**是否鉴权**​：否
* ​**请求参数**​：

| 参数名             | 类型   | 必选 | 示例        | 说明                                 |
| -------------------- | -------- | ------ | ------------- | -------------------------------------- |
| **account**  | String | 是   | zhangsan123 | 登录账号，支持用户名 / 邮箱 / 手机号 |
| **password** | String | 是   | Zhang@12345 | 登录密码                             |

* **响应参数：**

| 参数名             | 类型   | 示例                                     | 说明                     |
| -------------------- | -------- | ------------------------------------------ | -------------------------- |
| **token**    | String | eyJhbGciOiJIUzI1NiJ9...                  | JWT 令牌                 |
| **nickname** | String | 张三                                     | 用户昵称                 |
| **avatar**   | String | https://minio.xxx.com/avatar/default.png | 头像 URL，无则返回默认图 |

* ​**响应示例**​：

```JSON
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOiJmODFkNGZhZS03ZGVjLTExZDAtYTc2NS0wMGEwYzkxZTZiZjYiLCJ1c2VybmFtZSI6InpoYW5nc2FuMTIzIiwiZXhwIjoxNzM2Mjk0NDAwfQ.QP8n7x8f7a7s7d7f8s7d8f7s8d7f8s7d8f7s8d7f8s7d8",
    "nickname": "张三",
    "avatar": "https://minio.xxx.com/avatar/default.png"
  },
  "timestamp": 1735689600000
}
```

* ​**异常示例**​：

```JSON
{
  "code": 400,
  "msg": "用户名/密码错误",
  "data": null,
  "timestamp": 1735689600000
}
```

4. ###### 上传头像

* ​**接口路径**​：**`/avatar`**
* ​**请求方式**​：**POST**
* ​**接口描述**​：上传用户头像，存储到 MinIO，返回头像 URL
* ​**是否鉴权**​：是
* ​**请求参数（FormData 格式）**​：

| 参数名         | 类型 | 必选 | 示例 | 说明                                     |
| ---------------- | ------ | ------ | ------ | ------------------------------------------ |
| **file** | File | 是   | -    | 头像文件，仅支持 jpg/png 格式，大小≤5MB |

* **响应参数：**

| 参数名              | 类型   | 示例                                   | 说明         |
| --------------------- | -------- | ---------------------------------------- | -------------- |
| **avatarUrl** | String | https://minio.xxx.com/avatar/zs123.png | 头像访问 URL |

* ​**响应示例**​：

```JSON
{
  "code": 200,
  "msg": "头像上传成功",
  "data": {
    "avatarUrl": "https://minio.xxx.com/avatar/f81d4fae-7dec-11d0-a765-00a0c91e6bf6.png"
  },
  "timestamp": 1735689600000
}
```

5. ###### 修改个人信息

* ​**接口路径**​：**`/profile`**
* ​**请求方式**​：**PUT**
* ​**接口描述**​：修改用户个人资料（不含手机号 / 邮箱 / 密码）
* ​**是否鉴权**​：是
* ​**请求参数**​：

| 参数名             | 类型    | 必选 | 示例               | 说明                           |
| -------------------- | --------- | ------ | -------------------- | -------------------------------- |
| **nickname** | String  | 否   | 张三\_程序员       | 昵称，1-64 位，支持 Emoji      |
| **gender**   | Integer | 否   | 1                  | 性别：0 - 保密，1 - 男，2 - 女 |
| **region**   | String  | 否   | 北京市海淀区       | 地区                           |
| **settings** | JSON    | 否   | {"darkMode": true} | 前端偏好设置（如深色模式）     |

* ​**响应示例**​：

```JSON
{
  "code": 200,
  "msg": "个人信息修改成功",
  "data": null,
  "timestamp": 1735689600000
}
```

6. ###### 查看个人信息

* ​**接口路径**​：**`/profile`**
* ​**请求方式**​：**GET**
* ​**接口描述**​：查询用户个人信息
* ​**是否鉴权**​：是
* ​**请求参数**​：无（通过 Token 解析用户 ID）
* **响应参数：**

| 参数名               | 类型    | 示例                                                                                  | 说明                                               |
| ---------------------- | --------- | --------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| **username**   | String  | zhangsan123                                                                           | 用户名                                             |
| **nickname**   | String  | 张三\_程序员                                                                          | 昵称                                               |
| **email**      | String  | [zs@xxx.com](mailto:zs****@xxx.com)                                                      | 邮箱                                               |
| **phone**      | String  | 13822338000                                                                           | 手机号                                             |
| **avatar**     | String  | [https://minio.xxx.com/avatar/zs123.png](https://minio.xxx.com/avatar/zs123.png) | 头像 URL                                           |
| **gender**     | Integer | 1                                                                                     | 性别：0 - 保密，1 - 男，2 - 女                     |
| **genderDesc** | String  | 男                                                                                    | 性别描述                                           |
| **region**     | String  | 北京市海淀区                                                                          | 地区                                               |
| **status**     | Integer | 1                                                                                     | 账号状态：0 - 禁用，1 - 正常，2 - 未激活，3 - 注销 |
| **statusDesc** | String  | 正常                                                                                  | 状态描述                                           |
| **createTime** | String  | 2026/1/6 10:00                                                                        | 注册时间                                           |
| **settings**   | JSON    | {"darkMode": true}                                                                    | 前端偏好设置                                       |

* ​**响应示例**​：

```JSON
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "username": "zhangsan123",
    "nickname": "张三_程序员",
    "email": "zs****@xxx.com",
    "phone": "138****8000",
    "avatar": "https://minio.xxx.com/avatar/zs123.png",
    "gender": 1,
    "genderDesc": "男",
    "region": "北京市海淀区",
    "status": 1,
    "statusDesc": "正常",
    "createTime": "2026-01-06 10:00:00",
    "settings": {
      "darkMode": true,
      "defaultMapStyle": "normal"
    }
  },
  "timestamp": 1735689600000
}
```

7. ###### 账号注销

* ​**接口路径**​：**`/cancel`**
* ​**请求方式**​：**POST**
* ​**接口描述**​：用户主动注销账号，注销后状态改为 “注销”，不可恢复
* ​**是否鉴权**​：是
* ​**请求参数**​：

| 参数名             | 类型 | 必选 | 示例        | 说明                 |
| -------------------- | ------ | ------ | ------------- | ---------------------- |
| **password** | File | 是   | Zhang@12345 | 登录密码（二次验证） |

* **响应示例：**

```JSON
{
  "code": 200,
  "msg": "账号注销成功，如需恢复请联系管理员",
  "data": null,
  "timestamp": 1735689600000
}
```

* **异常示例**

```JSON
{"code": 400,"msg": "密码错误，注销失败","data": null,"timestamp": 1735689600000}
```

8. ###### 查看剩余积分

* ​**接口路径**​：**`/quota`**
* ​**请求方式**​：**GET**
* ​**接口描述**​：查询用户剩余积分
* ​**是否鉴权**​：是
* ​**请求参数**​：无（通过 Token 解析用户 ID）
* ​**响应参数**​：

| 参数名              | 类型    | 必选                 | 说明     |
| --------------------- | --------- | ---------------------- | ---------- |
| **quota**     | Integer | 999                  | 剩余积分 |
| **quotaDesc** | String  | 剩余 999 次 API 调用 | 积分描述 |

* **响应示例：**

```JSON
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "quota": 999,
    "quotaDesc": "剩余999次API调用"
  },
  "timestamp": 1735689600000
}
```

